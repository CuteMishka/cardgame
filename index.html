<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Card: –ò–º–ø–µ—Ä–∞—Ç–æ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .card-font { font-family: 'Cinzel', serif; }

        /* 3D Card Animations */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        @keyframes dealCard {
            from { transform: translateY(-100vh) rotate(720deg) scale(0.5); opacity: 0; }
            to { transform: translateY(0) rotate(0) scale(1); opacity: 1; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes revealWinner {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
            50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(255, 215, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        }

        .animate-deal { animation: dealCard 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) backwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-winner { animation: revealWinner 1s ease-out infinite; }

        /* Card Styles */
        .card-inner {
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bg-pattern {
            background-color: #0f172a;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-pattern min-h-screen text-gray-100 overflow-x-hidden">
    <div id="app"></div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
  apiKey: "AIzaSyBFjleDsbPvsNnlkKp9q5a-Xq3IyTus23o",
  authDomain: "card-game-d1fa1.firebaseapp.com",
  databaseURL: "https://card-game-d1fa1-default-rtdb.firebaseio.com",
  projectId: "card-game-d1fa1",
  storageBucket: "card-game-d1fa1.firebasestorage.app",
  messagingSenderId: "897674662962",
  appId: "1:897674662962:web:c7824186c666e30cacd82b",
  measurementId: "G-W9KWPSR8K8"
};

        let database = null;
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ä–∞–±–æ—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ Firebase
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";
        
        if (isFirebaseConfigured) {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (e) {
                console.error("Firebase Error:", e);
            }
        }

        // ==================== CONSTANTS & STATE ====================
        const CARDS = {
            E: { 
                id: 'E', name: '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä', role: 'Emperor', 
                icon: 'üëë', 
                desc: '–ü–æ–±–µ–∂–¥–∞–µ—Ç –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞',
                bg: 'bg-gradient-to-br from-yellow-600 via-yellow-500 to-amber-700',
                border: 'border-yellow-400',
                beats: 'C' 
            },
            C: { 
                id: 'C', name: '–ì—Ä–∞–∂–¥–∞–Ω–∏–Ω', role: 'Citizen', 
                icon: 'üë§', 
                desc: '–ü–æ–±–µ–∂–¥–∞–µ—Ç –†–∞–±–∞',
                bg: 'bg-gradient-to-br from-blue-600 via-blue-500 to-indigo-700',
                border: 'border-blue-400',
                beats: 'S' 
            },
            S: { 
                id: 'S', name: '–†–∞–±', role: 'Slave', 
                icon: '‚õìÔ∏è', 
                desc: '–ü–æ–±–µ–∂–¥–∞–µ—Ç –ò–º–ø–µ—Ä–∞—Ç–æ—Ä–∞',
                bg: 'bg-gradient-to-br from-gray-600 via-gray-500 to-gray-800',
                border: 'border-red-500',
                beats: 'E' 
            }
        };

        const INITIAL_DECK = ['E', 'S', 'C', 'C', 'C']; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–ª–æ–¥–∞ E-Card

        let state = {
            screen: 'menu',
            gameId: '',
            playerName: '',
            isHost: false,
            myCards: [], // –ë—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            opponentCardsCount: 5,
            myChoice: null,
            opponentChoice: null,
            myScore: 0,
            opponentScore: 0,
            round: 1,
            opponentName: '???',
            waitingForOpponent: false,
            roundResult: null, // 'win', 'lose', 'draw'
            gameResult: null,  // 'win', 'lose', 'draw'
            error: '',
            showModal: null,
            revealPhase: false // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Å–∫—Ä—ã—Ç–∏—è
        };

        // ==================== STORAGE & SYNC ====================
        function saveGame(gameId, data) {
            if (database) {
                database.ref('games/' + gameId).set(data);
            } else {
                localStorage.setItem('game_' + gameId, JSON.stringify(data));
                // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–≥—Ä—ã
                setTimeout(() => window.dispatchEvent(new Event('storage')), 50);
            }
        }

        function updateGame(gameId, updates) {
            if (database) {
                database.ref('games/' + gameId).update(updates);
            } else {
                const current = JSON.parse(localStorage.getItem('game_' + gameId) || '{}');
                const newData = { ...current, ...updates };
                localStorage.setItem('game_' + gameId, JSON.stringify(newData));
                window.dispatchEvent(new Event('storage'));
            }
        }

        function watchGame(gameId, callback) {
            if (database) {
                database.ref('games/' + gameId).on('value', (snapshot) => {
                    callback(snapshot.val());
                });
            } else {
                const interval = setInterval(() => {
                    const data = localStorage.getItem('game_' + gameId);
                    if (data) callback(JSON.parse(data));
                }, 500);
                return () => clearInterval(interval);
            }
        }

        function loadGame(gameId, callback) {
            if (database) {
                database.ref('games/' + gameId).once('value').then((s) => callback(s.val()));
            } else {
                const data = localStorage.getItem('game_' + gameId);
                callback(data ? JSON.parse(data) : null);
            }
        }

        // ==================== CORE LOGIC ====================
        
        // --- 1. BUG FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã ---
        function playCard(cardType) {
            if (state.myChoice || state.waitingForOpponent) return;

            loadGame(state.gameId, (game) => {
                const myRole = state.isHost ? 'player1' : 'player2';
                const currentCards = game[myRole + 'Cards'] || [];
                
                // –ù–∞—Ö–æ–¥–∏–º –ò–ù–î–ï–ö–° –ø–µ—Ä–≤–æ–π –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∫–∞—Ä—Ç—ã
                const cardIndex = currentCards.indexOf(cardType);

                if (cardIndex === -1) {
                    console.error("–ü–æ–ø—ã—Ç–∫–∞ —Å—ã–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç–æ–π, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ä—É–∫–µ!");
                    return;
                }

                // –£–¥–∞–ª—è–µ–º —Ä–æ–≤–Ω–æ –æ–¥–Ω—É –∫–∞—Ä—Ç—É –ø–æ –∏–Ω–¥–µ–∫—Å—É
                currentCards.splice(cardIndex, 1);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const updates = {};
                updates[myRole + 'Cards'] = currentCards;
                updates[myRole + 'Choice'] = cardType;

                state.myCards = currentCards;
                state.myChoice = cardType;
                state.waitingForOpponent = true;

                updateGame(state.gameId, updates);
                render();
            });
        }

        function determineWinner(card1, card2) {
            if (card1 === card2) return 'draw';
            if (CARDS[card1].beats === card2) return 'player';
            return 'opponent';
        }

        function createGame() {
            const name = document.getElementById('createName').value.trim();
            if (!name) return setError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');

            const gameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            const deck = [...INITIAL_DECK].sort(() => Math.random() - 0.5); // –ü–µ—Ä–µ–º–µ—à–∞–µ–º

            const gameData = {
                player1Name: name,
                player2Name: null,
                currentRound: 1,
                player1Choice: null,
                player2Choice: null,
                player1Cards: deck,
                player2Cards: deck, // –£ –æ–±–æ–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –Ω–∞–±–æ—Ä
                player1Score: 0,
                player2Score: 0,
                status: 'waiting', // waiting, playing, finished
                createdAt: Date.now()
            };

            saveGame(gameId, gameData);

            state.gameId = gameId;
            state.playerName = name;
            state.isHost = true;
            state.screen = 'lobby';
            state.myCards = deck;
            state.showModal = null;
            render();
            startWatching();
        }

        function joinGame() {
            const name = document.getElementById('joinName').value.trim();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();

            if (!name) return setError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            if (!code) return setError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');

            loadGame(code, (game) => {
                if (!game) return setError('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                if (game.player2Name) return setError('–ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç');

                const deck = [...INITIAL_DECK].sort(() => Math.random() - 0.5);

                updateGame(code, {
                    player2Name: name,
                    status: 'playing',
                    player2Cards: deck
                });

                state.gameId = code;
                state.playerName = name;
                state.opponentName = game.player1Name;
                state.isHost = false;
                state.screen = 'playing';
                state.myCards = deck;
                state.showModal = null;

                render();
                startWatching();
            });
        }

        function startWatching() {
            watchGame(state.gameId, (game) => {
                if (!game) return;

                // –õ–æ–±–±–∏ -> –ò–≥—Ä–∞
                if (state.screen === 'lobby' && game.player2Name) {
                    state.opponentName = game.player2Name;
                    state.screen = 'playing';
                    render();
                }

                // –õ–æ–≥–∏–∫–∞ —Ä–∞—É–Ω–¥–∞
                if (state.screen === 'playing') {
                    const myRole = state.isHost ? 'player1' : 'player2';
                    const oppRole = state.isHost ? 'player2' : 'player1';

                    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                    state.myCards = game[myRole + 'Cards'] || [];
                    state.opponentCardsCount = (game[oppRole + 'Cards'] || []).length;
                    state.myScore = game[myRole + 'Score'] || 0;
                    state.opponentScore = game[oppRole + 'Score'] || 0;
                    state.round = game.currentRound;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã
                    if (game.status === 'finished') {
                        state.gameResult = state.myScore > state.opponentScore ? 'win' : (state.myScore < state.opponentScore ? 'lose' : 'draw');
                        state.screen = 'finished';
                        render();
                        return;
                    }

                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö–æ–¥–∞ (Showdown)
                    const myChoice = game[myRole + 'Choice'];
                    const oppChoice = game[oppRole + 'Choice'];

                    if (myChoice && oppChoice && !state.revealPhase) {
                        // –û–±–∞ –ø–æ—Ö–æ–¥–∏–ª–∏, –Ω–∞—á–∏–Ω–∞–µ–º —Ñ–∞–∑—É –≤—Å–∫—Ä—ã—Ç–∏—è
                        state.myChoice = myChoice;
                        state.opponentChoice = oppChoice;
                        state.revealPhase = true;
                        state.waitingForOpponent = false;

                        const roundWinner = determineWinner(myChoice, oppChoice);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥–∞ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        if (roundWinner === 'player') state.roundResult = 'win';
                        else if (roundWinner === 'opponent') state.roundResult = 'lose';
                        else state.roundResult = 'draw';

                        render(); // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–∫—Ä—ã—Ç—ã–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª–µ

                        // –¢–∞–π–º–µ—Ä –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Å–∫—Ä—ã—Ç–∏—è
                        setTimeout(() => {
                            // –ï—Å–ª–∏ —è —Ö–æ—Å—Ç, —è –æ–±–Ω–æ–≤–ª—è—é —Å—á–µ—Ç –≤ –ë–î
                            if (state.isHost) {
                                const updates = {
                                    player1Choice: null, // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
                                    player2Choice: null,
                                    currentRound: game.currentRound + 1
                                };
                                
                                if (roundWinner === 'player') updates[myRole + 'Score'] = (game[myRole + 'Score'] || 0) + 1;
                                else if (roundWinner === 'opponent') updates[oppRole + 'Score'] = (game[oppRole + 'Score'] || 0) + 1;

                                if (game.currentRound >= 5) {
                                    updates.status = 'finished';
                                }

                                updateGame(state.gameId, updates);
                            }
                        }, 4000); // 4 —Å–µ–∫—É–Ω–¥—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    } 
                    else if (!myChoice && !oppChoice && state.revealPhase) {
                        // –°–±—Ä–æ—Å –Ω–∞ –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥
                        state.revealPhase = false;
                        state.myChoice = null;
                        state.opponentChoice = null;
                        state.roundResult = null;
                        render();
                    }
                }
            });
        }

        // ==================== UI HELPERS ====================
        function setError(msg) {
            state.error = msg;
            render();
            setTimeout(() => { state.error = ''; render(); }, 3000);
        }

        function showModal(type) {
            state.showModal = type;
            state.error = '';
            render();
        }

        function closeModal() {
            state.showModal = null;
            render();
        }

        function resetApp() {
            window.location.reload();
        }

        // ==================== RENDERER ====================
        function render() {
            const app = document.getElementById('app');
            let content = '';

            // --- Modal Overlays ---
            if (state.showModal) {
                content += renderModal();
            }

            // --- Screens ---
            if (state.screen === 'menu') {
                content += renderMenu();
            } else if (state.screen === 'lobby') {
                content += renderLobby();
            } else if (state.screen === 'playing') {
                content += renderGame();
            } else if (state.screen === 'finished') {
                content += renderFinished();
            }

            app.innerHTML = content;
        }

        function renderCard(cardType, isFaceUp = true, isInteractable = false, delay = 0) {
            const card = CARDS[cardType] || {};
            
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ª–∏—Ü–æ–º –≤–Ω–∏–∑ (—Ä—É–±–∞—à–∫–∞)
            if (!isFaceUp) {
                return `
                    <div class="relative w-24 h-36 rounded-xl shadow-2xl transition-all duration-300 transform hover:-translate-y-2 animate-deal" style="animation-delay: ${delay}s">
                         <div class="w-full h-full rounded-xl bg-gradient-to-br from-gray-800 to-black border-2 border-gray-600 flex items-center justify-center overflow-hidden">
                            <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]"></div>
                            <div class="text-4xl opacity-50">‚öîÔ∏è</div>
                         </div>
                    </div>
                `;
            }

            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –ª–∏—Ü–æ–º –≤–≤–µ—Ä—Ö
            return `
                <div 
                    onclick="${isInteractable ? `playCard('${cardType}')` : ''}" 
                    class="
                        group relative w-24 h-36 perspective-1000 cursor-pointer 
                        ${isInteractable ? 'hover:-translate-y-6 hover:rotate-2 hover:z-10 transition-all duration-300' : ''}
                        animate-deal
                    "
                    style="animation-delay: ${delay}s"
                >
                    <div class="w-full h-full rounded-xl shadow-2xl ${card.bg} p-1 border-2 ${card.border} relative overflow-hidden">
                        <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
                        
                        <div class="w-full h-full border border-white/20 rounded-lg flex flex-col items-center justify-between p-2">
                            <div class="text-xs font-bold text-white/80 self-start">${card.id}</div>
                            <div class="text-5xl filter drop-shadow-lg transform group-hover:scale-110 transition-transform">${card.icon}</div>
                            <div class="text-center">
                                <div class="text-[10px] uppercase tracking-wider text-white/60">${card.role}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // –†–µ–Ω–¥–µ—Ä –±–æ–ª—å—à–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è —Å—Ç–æ–ª–∞ (—Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞)
        function renderTableCard(cardType, isRevealed, isWinner) {
            const card = CARDS[cardType];
            
            return `
                <div class="w-32 h-48 perspective-1000 ${isWinner ? 'animate-winner z-20' : ''}">
                    <div class="relative w-full h-full transition-transform duration-700 transform-style-3d ${isRevealed ? 'rotate-y-180' : ''}">
                        
                        <div class="absolute w-full h-full backface-hidden rounded-xl bg-gray-900 border-4 border-gray-700 shadow-xl flex items-center justify-center bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]">
                            <span class="text-5xl opacity-20">‚öîÔ∏è</span>
                        </div>

                        <div class="absolute w-full h-full backface-hidden rotate-y-180 rounded-xl ${card.bg} border-4 ${card.border} shadow-2xl p-2 flex flex-col items-center justify-center">
                            <div class="text-6xl mb-2 drop-shadow-md">${card.icon}</div>
                            <div class="font-bold text-white text-lg font-cinzel">${card.name}</div>
                            <div class="text-xs text-center text-white/80 mt-2 px-1">${card.desc}</div>
                        </div>

                    </div>
                </div>
            `;
        }

        function renderModal() {
            const isCreate = state.showModal === 'create';
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div class="glass-panel w-full max-w-md p-8 rounded-2xl shadow-2xl border border-gray-700 animate-deal">
                        <h2 class="text-3xl font-bold text-white mb-6 text-center text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-200">
                            ${isCreate ? '–°–æ–∑–¥–∞—Ç—å —Å—Ç–æ–ª' : '–í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É'}
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-400 text-sm mb-1">–í–∞—à–µ –∏–º—è</label>
                                <input id="${isCreate ? 'createName' : 'joinName'}" type="text" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            
                            ${!isCreate ? `
                            <div>
                                <label class="block text-gray-400 text-sm mb-1">–ö–æ–¥ —Å—Ç–æ–ª–∞</label>
                                <input id="joinCode" type="text" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white font-mono uppercase focus:ring-2 focus:ring-amber-500 outline-none">
                            </div>
                            ` : ''}

                            ${state.error ? `<div class="text-red-400 text-sm text-center bg-red-900/20 p-2 rounded">${state.error}</div>` : ''}

                            <div class="flex gap-3 mt-6">
                                <button onclick="closeModal()" class="flex-1 py-3 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-800 transition">–û—Ç–º–µ–Ω–∞</button>
                                <button onclick="${isCreate ? 'createGame()' : 'joinGame()'}" class="flex-1 py-3 rounded-lg bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-bold hover:shadow-lg hover:from-amber-500 hover:to-yellow-500 transition shadow-amber-900/20">
                                    ${isCreate ? '–°–æ–∑–¥–∞—Ç—å' : '–ù–∞—á–∞—Ç—å'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMenu() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen p-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-96 h-96 bg-purple-900/30 rounded-full blur-[100px]"></div>
                    <div class="absolute bottom-0 right-0 w-96 h-96 bg-amber-900/30 rounded-full blur-[100px]"></div>

                    <div class="z-10 text-center space-y-8 animate-float">
                        <div class="mb-12">
                            <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-amber-200 via-yellow-400 to-amber-700 drop-shadow-2xl tracking-tighter">
                                IMPERATOR
                            </h1>
                            <p class="text-gray-400 text-lg tracking-[0.5em] mt-2 uppercase">Card Battle</p>
                        </div>

                        <div class="flex flex-col gap-4 w-full max-w-xs mx-auto">
                            <button onclick="showModal('create')" class="group relative px-8 py-4 bg-gray-800 rounded-xl overflow-hidden border border-amber-500/30 transition-all hover:scale-105 hover:border-amber-400 hover:shadow-[0_0_30px_rgba(245,158,11,0.3)]">
                                <div class="absolute inset-0 bg-gradient-to-r from-amber-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <span class="relative font-bold text-xl text-amber-100">–ù–æ–≤–∞—è –∏–≥—Ä–∞</span>
                            </button>
                            
                            <button onclick="showModal('join')" class="group relative px-8 py-4 bg-gray-800 rounded-xl overflow-hidden border border-blue-500/30 transition-all hover:scale-105 hover:border-blue-400 hover:shadow-[0_0_30px_rgba(59,130,246,0.3)]">
                                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <span class="relative font-bold text-xl text-blue-100">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</span>
                            </button>
                        </div>
                        
                        ${!isFirebaseConfigured ? '<div class="text-xs text-gray-600 mt-8">–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞)</div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderLobby() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass-panel max-w-lg w-full p-10 rounded-3xl text-center space-y-8 relative">
                        <div class="absolute -top-4 -right-4 text-6xl animate-bounce">‚è≥</div>
                        
                        <h2 class="text-3xl font-bold text-white">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞</h2>
                        
                        <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                            <p class="text-gray-400 text-sm mb-2">–°–æ–æ–±—â–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–≥—É:</p>
                            <div class="text-5xl font-mono text-amber-400 tracking-widest select-all cursor-pointer hover:text-amber-300 transition" onclick="navigator.clipboard.writeText('${state.gameId}')">
                                ${state.gameId}
                            </div>
                        </div>

                        <div class="flex justify-center gap-2">
                            <span class="w-3 h-3 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                            <span class="w-3 h-3 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="w-3 h-3 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </div>

                        <button onclick="resetApp()" class="text-gray-500 hover:text-white text-sm underline">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
        }

        function renderGame() {
            const isWin = state.roundResult === 'win';
            const isLose = state.roundResult === 'lose';

            return `
                <div class="h-screen flex flex-col justify-between overflow-hidden bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black">
                    
                    <div class="flex justify-between items-center p-4 bg-black/40 backdrop-blur-md border-b border-white/5 z-50">
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <div class="text-xs text-gray-400">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</div>
                                <div class="font-bold text-lg text-white">${state.opponentName}</div>
                            </div>
                            <div class="text-3xl font-black text-red-500">${state.opponentScore}</div>
                        </div>
                        
                        <div class="bg-gray-800 px-4 py-1 rounded-full text-xs font-mono text-gray-400 border border-gray-700">
                            –†–ê–£–ù–î ${state.round} / 5
                        </div>

                        <div class="flex items-center gap-4">
                            <div class="text-3xl font-black text-green-500">${state.myScore}</div>
                            <div>
                                <div class="text-xs text-gray-400">–í—ã</div>
                                <div class="font-bold text-lg text-white">${state.playerName}</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 relative flex flex-col items-center justify-center perspective-1000">
                        
                        <div class="absolute top-4 flex justify-center gap-2 -scale-75 opacity-70">
                             ${Array(state.opponentCardsCount).fill(0).map((_, i) => renderCard(null, false, false, i * 0.1)).join('')}
                        </div>

                        ${state.waitingForOpponent && !state.revealPhase ? `
                            <div class="absolute z-10 bg-black/60 px-6 py-3 rounded-full text-white animate-pulse border border-white/20 backdrop-blur">
                                –û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ–¥–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...
                            </div>
                        ` : ''}

                        ${state.roundResult ? `
                            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none">
                                <h2 class="text-6xl md:text-8xl font-black uppercase tracking-tighter 
                                    ${isWin ? 'text-green-500 drop-shadow-[0_0_20px_rgba(34,197,94,0.6)]' : 
                                      isLose ? 'text-red-500 drop-shadow-[0_0_20px_rgba(239,68,68,0.6)]' : 'text-gray-300'} 
                                    animate-bounce">
                                    ${isWin ? '–ü–û–ë–ï–î–ê!' : isLose ? '–ü–û–†–ê–ñ–ï–ù–ò–ï' : '–ù–ò–ß–¨–Ø'}
                                </h2>
                            </div>
                        ` : ''}

                        <div class="flex items-center gap-8 md:gap-16 transform scale-110 md:scale-125">
                            
                            <div class="relative w-32 h-48 rounded-xl border-2 border-dashed border-white/10 flex items-center justify-center">
                                ${state.opponentChoice ? 
                                    renderTableCard(state.opponentChoice, state.revealPhase, state.roundResult === 'lose') 
                                    : '<span class="text-white/10 text-4xl">?</span>'}
                            </div>

                            <div class="text-2xl font-black text-amber-500 italic bg-black/50 p-2 rounded-full border border-amber-500/50">VS</div>

                            <div class="relative w-32 h-48 rounded-xl border-2 border-dashed border-white/10 flex items-center justify-center">
                                ${state.myChoice ? 
                                    renderTableCard(state.myChoice, true, state.roundResult === 'win') 
                                    : '<span class="text-white/10 text-4xl">?</span>'}
                            </div>

                        </div>
                    </div>

                    <div class="relative h-48 bg-gradient-to-t from-black via-gray-900 to-transparent flex items-end justify-center pb-6 gap-2 md:gap-4 overflow-visible z-40">
                         ${state.myCards.length > 0 ? 
                            state.myCards.map((c, i) => renderCard(c, true, !state.myChoice, i * 0.1)).join('') : 
                            '<div class="text-gray-500 pb-10">–ù–µ—Ç –∫–∞—Ä—Ç</div>'
                         }
                    </div>

                </div>
            `;
        }

        function renderFinished() {
            const isWin = state.gameResult === 'win';
            const color = isWin ? 'text-green-500' : (state.gameResult === 'lose' ? 'text-red-500' : 'text-gray-400');
            const bg = isWin ? 'from-green-900/40 to-black' : 'from-red-900/40 to-black';

            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br ${bg} p-4">
                    <div class="glass-panel p-12 rounded-3xl text-center max-w-2xl w-full border-t border-white/20 shadow-2xl animate-deal">
                        
                        <div class="text-8xl mb-6 filter drop-shadow-2xl">
                            ${isWin ? 'üëë' : (state.gameResult === 'lose' ? 'üíÄ' : '‚öñÔ∏è')}
                        </div>

                        <h2 class="text-6xl font-black ${color} mb-2 tracking-tighter uppercase">
                            ${isWin ? '–í–ï–õ–ò–ö–ê–Ø –ü–û–ë–ï–î–ê' : (state.gameResult === 'lose' ? '–ü–û–†–ê–ñ–ï–ù–ò–ï' : '–ù–ò–ß–¨–Ø')}
                        </h2>
                        
                        <div class="flex justify-center gap-12 my-12 text-white">
                            <div>
                                <div class="text-gray-400 text-sm uppercase tracking-widest">–í—ã</div>
                                <div class="text-5xl font-bold">${state.myScore}</div>
                            </div>
                            <div class="w-px bg-gray-700"></div>
                            <div>
                                <div class="text-gray-400 text-sm uppercase tracking-widest">${state.opponentName}</div>
                                <div class="text-5xl font-bold">${state.opponentScore}</div>
                            </div>
                        </div>

                        <button onclick="resetApp()" class="w-full py-4 bg-white text-black font-bold text-xl rounded-xl hover:bg-gray-200 transition transform hover:-translate-y-1 shadow-xl">
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é
                        </button>
                    </div>
                </div>
            `;
        }

        // Init
        render();

    </script>
</body>
</html>
